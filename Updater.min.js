// REWIND GAMING BROADCAST OVERLAY UPDATER
// VERSION 0.1
// LICENSED UNDER GPL-3.0

// FOR DOCUMENTATION AND LICENSING INFORMATION PLEASE SEE:
// https://github.com/rewindrl/updater

class GraphicsUpdater{constructor(e,t,s,o,r=3e3){const a=(()=>{let t=[];for(let s of Object.values(e))for(let e of Object.keys(s))t.push(e.match(/[a-zA-Z]+|[0-9]+/g));return t})().map(e=>[this.colToIndex(e[0]),parseInt(e[1])]),n=(()=>{const e=a.map(e=>e[0]),t=a.map(e=>e[1]);return[Math.min(...e),Math.min(...t),Math.max(...e),Math.max(...t)]})(),i=`${this.indexToCol(n[0])}${n[1]}:${this.indexToCol(n[2])}${n[3]}`;this.url=`https://sheets.googleapis.com/v4/spreadsheets/${t}/values/${s}!${i}?key=${o}&majorDimension=COLUMNS&valueRenderOption=FORMATTED_VALUE`,this.arrayMap=(()=>{let t={};for(let s of Object.keys(e)){t[s]={};for(let o of Object.keys(e[s])){let r=o.match(/[a-zA-Z]+|[0-9]+/g);r[0]=this.colToIndex(r[0]),r=r.map((e,t)=>e-n[t]),t[s][r.toString()]=e[s][o]}}return t})(),this.simpleOperations=["string","image"],this.operations={string:(e,t)=>document.getElementById(e).innerHTML=t,image:(e,t)=>document.getElementById(e).src=t,counter:(e,t)=>{try{t=parseInt(t)}catch(e){throw"Failed to parse number from spreadsheet: make sure it's a number!"}for(let s=0;s<t;s++)document.getElementById(e[s]).style.display="";for(let s=t;s<e.length;s++)document.getElementById(e[s]).style.display="none"},switch:(e,t)=>{for(let s of Object.keys(e))document.getElementById(e[s]).style.display=s==t?"":"none"}},this.update(),setInterval(this.update.bind(this),r)}async update(){let e,t,s;try{let t=await fetch(this.url);if(!t.ok)throw"Failed to find your spreadsheet!";e=await t.json()}catch(e){throw"Failed to access spreadsheet on Google Sheets API"}e=e.values;for(let o of Object.keys(this.arrayMap)){s=this.simpleOperations.includes(o)?(e,t)=>{if(Array.isArray(e))for(let s of e)this.operations[o](s,t);else this.operations[o](e,t)}:(e,t)=>this.operations[o](e,t);for(let r of Object.keys(this.arrayMap[o]))t=r.split(",").map(e=>e.toString()),s(this.arrayMap[o][r],e[t[0]][t[1]])}}colToIndex(e){let t,s,o="ABCDEFGHIJKLMNOPQRSTUVWXYZ",r=0;for(t=0,s=e.length-1;t<e.length;t+=1,s-=1)r+=Math.pow(o.length,s)*(o.indexOf(e[t])+1);return r}indexToCol(e){for(var t="",s=1,o=26;(e-=s)>=0;s=o,o*=26)t=String.fromCharCode(parseInt(e%o/s)+65)+t;return t}}