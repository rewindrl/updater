// REWIND GAMING BROADCAST OVERLAY UPDATER
// VERSION 1.1
// LICENSED UNDER GPL-3.0

// FOR DOCUMENTATION AND LICENSING INFORMATION PLEASE SEE:
// https://github.com/rewindrl/updater

class GraphicsUpdater{constructor(t,e,r,a,o=3e3,s=!0){this.updating=!1;const i=(()=>{let e=[];for(let r of Object.values(t))for(let t of Object.keys(r))e.push(t.match(/[a-zA-Z]+|[0-9]+/g));return e})().map(t=>[this.colToIndex(t[0]),parseInt(t[1])]),n=(()=>{const t=i.map(t=>t[0]),e=i.map(t=>t[1]);return[Math.min(...t),Math.min(...e),Math.max(...t),Math.max(...e)]})(),l=`${this.indexToCol(n[0])}${n[1]}:${this.indexToCol(n[2])}${n[3]}`;this.url=`https://sheets.googleapis.com/v4/spreadsheets/${e}/values/${r}!${l}?key=${a}&majorDimension=COLUMNS&valueRenderOption=FORMATTED_VALUE`,this.arrayMap=(()=>{let e={};for(let r of Object.keys(t)){e[r]={};for(let a of Object.keys(t[r])){let o=a.match(/[a-zA-Z]+|[0-9]+/g);o[0]=this.colToIndex(o[0]),o=o.map((t,e)=>t-n[e]),e[r][o.toString()]=t[r][a]}}return e})(),this.simpleOperations=["string","image"],this.operations={string:(t,e)=>document.getElementById(t).innerHTML=e,image:(t,e)=>document.getElementById(t).src=e,counter:(t,e)=>{try{e=parseInt(e)}catch(r){console.warn(`Failed to parse counter number '${e.toString()}' for ID(s) '${t.toString}' from spreadsheet: make sure it's a number!\nReceived the following error:\n${r.toString()}`)}for(let r=0;r<e;r++)document.getElementById(t[r]).style.display="";for(let r=e;r<t.length;r++)document.getElementById(t[r]).style.display="none"},switch:(t,e)=>{for(let r of Object.keys(t))document.getElementById(t[r]).style.display=r==e?"":"none"}},this.updateInterval=o,s&&this.startUpdating()}async update(){let t,e,r;try{let e=await fetch(this.url);if(!e.ok)throw"Failed to find your spreadsheet! Make sure it's public and the given ID is correct.";t=await e.json()}catch(t){throw"Failed to access spreadsheet on Google Sheets API! Make sure your API key is correct, and enabled on the Google Sheets API."}t=t.values;for(let a of Object.keys(this.arrayMap)){r=this.simpleOperations.includes(a)?(t,e)=>{if(Array.isArray(t))for(let r of t)this.operations[a](r,e);else this.operations[a](t,e)}:(t,e)=>this.operations[a](t,e);for(let o of Object.keys(this.arrayMap[a])){e=o.split(",").map(t=>t.toString());const s=(()=>{const r=t[e[0]];if(r){if("string"==typeof r[e[1]])return r[e[1]]}return""})();try{r(this.arrayMap[a][o],s)}catch(t){console.warn(`Failed to update ${this.arrayMap[a][o].toString()} with value ${s.toString()}!\nReceived the following error:\n${t.toString()}`)}}}}addOperation(t,e,r=!1){t in this.operations?console.warn(`Failed to add operation ${t} to operation structure - it already exists! Try a different name.`):(this.operations[t]=e,r&&this.simpleOperations.push(t))}importPreset(t){this.addOperation(...Object.values(t))}startUpdating(){this.updating?console.warn("Failed to start updating: the updater is already updating!"):(this.update(),setInterval(this.update.bind(this),this.updateInterval),this.updating=!0)}colToIndex(t){let e,r,a="ABCDEFGHIJKLMNOPQRSTUVWXYZ",o=0;for(e=0,r=t.length-1;e<t.length;e+=1,r-=1)o+=Math.pow(a.length,r)*(a.indexOf(t[e])+1);return o}indexToCol(t){for(var e="",r=1,a=26;(t-=r)>=0;r=a,a*=26)e=String.fromCharCode(parseInt(t%a/r)+65)+e;return e}}