// REWIND GAMING BROADCAST OVERLAY UPDATER
// VERSION 1.2
// LICENSED UNDER GPL-3.0

// FOR DOCUMENTATION AND LICENSING INFORMATION PLEASE SEE:
// https://github.com/rewindrl/updater

class GraphicsUpdater{constructor(t,e,a,s,o=3e3,r=!0){this.updating=!1;const n=(()=>{let e=[];for(let a of Object.values(t))for(let t of Object.keys(a))e.push(t.match(/[a-zA-Z]+|[0-9]+/g));return e})().map(t=>[this.colToIndex(t[0]),parseInt(t[1])]),i=(()=>{const t=n.map(t=>t[0]),e=n.map(t=>t[1]);return[Math.min(...t),Math.min(...e),Math.max(...t),Math.max(...e)]})(),l=`${this.indexToCol(i[0])}${i[1]}:${this.indexToCol(i[2])}${i[3]}`;this.url=`https://sheets.googleapis.com/v4/spreadsheets/${e}/values/${a}!${l}?key=${s}&majorDimension=COLUMNS&valueRenderOption=FORMATTED_VALUE`,this.arrayMap=(()=>{let e={};for(let a of Object.keys(t)){e[a]={};for(let s of Object.keys(t[a])){let o=s.match(/[a-zA-Z]+|[0-9]+/g);o[0]=this.colToIndex(o[0]),o=o.map((t,e)=>t-i[e]),e[a][o.toString()]=t[a][s]}}return e})(),this.simpleOperations=["string","image"],this.operations={string:(t,e)=>document.getElementById(t).innerHTML=e,image:(t,e)=>document.getElementById(t).src=e,counter:(t,e)=>{0==e?e=0:NaN===(e=parseInt(e))&&(console.warn("Failed to parse counter value from spreadsheet: make sure it's a number!\nDefaulting to 0."),e=0);for(let a=0;a<e;a++)document.getElementById(t[a]).style.display="";for(let a=e;a<t.length;a++)document.getElementById(t[a]).style.display="none"},switch:(t,e)=>{let a=!1;for(let s of Object.keys(t))s==e?(document.getElementById(t[s]).style.display="",a=!0):document.getElementById(t[s]).style.display="none";a||console.warn(`Hid all elements in a switch: none of the keys matched cell value ${e}!`)}},this.updateInterval=o,r&&this.startUpdating()}async update(){let t,e,a;try{let e=await fetch(this.url);if(!e.ok)throw"Failed to find your spreadsheet! Make sure it's public and the given ID is correct.";t=await e.json()}catch(t){throw"Failed to access spreadsheet on Google Sheets API! Make sure your API key is correct, and enabled on the Google Sheets API."}t=t.values;for(let s of Object.keys(this.arrayMap)){a=this.simpleOperations.includes(s)?(t,e)=>{if(Array.isArray(t))for(let a of t)this.operations[s](a,e);else this.operations[s](t,e)}:(t,e)=>this.operations[s](t,e);for(let o of Object.keys(this.arrayMap[s])){e=o.split(",").map(t=>t.toString());const r=(()=>{const a=t[e[0]];if(a){if("string"==typeof a[e[1]])return a[e[1]]}return""})();try{a(this.arrayMap[s][o],r)}catch(t){console.warn(`Failed to update ${this.arrayMap[s][o].toString()} with value ${r.toString()}!\nReceived the following error:\n${t.toString()}`)}}}}addOperation(t,e,a=!1){t in this.operations?console.warn(`Failed to add operation ${t} to operation structure - it already exists! Try a different name.`):(this.operations[t]=e,a&&this.simpleOperations.push(t))}importPreset(t){this.addOperation(...Object.values(t))}startUpdating(){this.updating?console.warn("Failed to start updating: the updater is already updating!"):(this.update(),setInterval(this.update.bind(this),this.updateInterval),this.updating=!0)}colToIndex(t){let e,a,s="ABCDEFGHIJKLMNOPQRSTUVWXYZ",o=0;for(e=0,a=t.length-1;e<t.length;e+=1,a-=1)o+=Math.pow(s.length,a)*(s.indexOf(t[e])+1);return o}indexToCol(t){for(var e="",a=1,s=26;(t-=a)>=0;a=s,s*=26)e=String.fromCharCode(parseInt(t%s/a)+65)+e;return e}}